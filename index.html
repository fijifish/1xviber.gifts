<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="">
    <title>AIMI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div id="root"></div>  <!-- ✅ ОБЯЗАТЕЛЬНО ДОЛЖЕН БЫТЬ! -->

    <script type="module" src="/src/main.jsx"></script>

    <script>
    (function(){
    const LOG_ENDPOINT = '/client-log'; // бэкенд — см. далее
    const sessionId = 'sess_' + Math.random().toString(36).slice(2,9) + '_' + Date.now();

    function send(payload) {
        // Добавляем минимальную задержку — чтобы WebView имел время инициализироваться
        try {
        // use beacon when possible (works on page unload reliably)
        if (navigator.sendBeacon) {
            const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
            navigator.sendBeacon(LOG_ENDPOINT, blob);
            return;
        }
        } catch(e) {}
        // fallback
        fetch(LOG_ENDPOINT, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload),
        keepalive: true
        }).catch(()=>{ /* silent */});
    }

    function makeBasePayload(extra = {}) {
        return {
        ts: new Date().toISOString(),
        sessionId,
        origin: location.origin,
        href: location.href,
        ua: navigator.userAgent || '',
        platform: navigator.platform || '',
        online: navigator.onLine,
        telegramUser: window.Telegram?.WebApp?.initDataUnsafe?.user || window.__TG_USER__ || null,
        ...extra
        };
    }

    // 1) Resource load errors (script/link/img)
    window.addEventListener('error', function (e) {
        try {
        const t = e.target || {};
        if (t.tagName && (t.src || t.href)) {
            const url = t.src || t.href;
            send(makeBasePayload({ type: 'resource-error', tag: t.tagName, url, outerHTML: (t.outerHTML || '').slice(0,500) }));
        } else {
            send(makeBasePayload({ type: 'js-error', message: e.message, file: e.filename, line: e.lineno, col: e.colno }));
        }
        } catch(_) {}
    }, true);

    // 2) Unhandled promise rejections
    window.addEventListener('unhandledrejection', function(e){
        try {
        send(makeBasePayload({ type: 'unhandledrejection', reason: String(e.reason) }));
        } catch(_) {}
    });

    // 3) After load: scan performance resources for entries with transferSize===0 or status 0
    window.addEventListener('load', function(){
        setTimeout(function(){
        try {
            const resources = performance.getEntriesByType('resource') || [];
            const problematic = [];
            for (const r of resources) {
            // transferSize==0 commonly for blocked fonts/scripts/images; also check name startsWith http
            if (r.name && r.name.startsWith('http') && (r.transferSize === 0 || (r.responseStatus && r.responseStatus >= 400) )) {
                problematic.push({ name: r.name, initiatorType: r.initiatorType, transferSize: r.transferSize, duration: r.duration });
            }
            }
            if (problematic.length) {
            send(makeBasePayload({ type: 'perf-problems', problems: problematic }));
            }
        } catch(e){ /* ignore */ }
        }, 800); // small delay
    });

    // 4) Optional: periodic heartbeat for 10s to catch late failures
    let heartbeatCount = 0;
    const hb = setInterval(() => {
        heartbeatCount++;
        try {
        send(makeBasePayload({ type: 'heartbeat', seq: heartbeatCount }));
        } catch(_) {}
        if (heartbeatCount >= 3) clearInterval(hb);
    }, 3000);

    })();
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.disableVerticalSwipes();
                window.Telegram.WebApp.setHeaderColor("#000000");
                window.Telegram.WebApp.expand();
            }
        });
    </script>

</body>
</html>